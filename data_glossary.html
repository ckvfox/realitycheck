<!-- data_glossary.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RealityCheck â€“ Data Glossary</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- ðŸŒ Einheitlicher Intro-Bereich -->
  <section class="page-intro">
    <h1>ðŸ“Š RealityCheck â€“ Data Glossary</h1>
    <p>
      This overview lists all <strong>indicators currently used in RealityCheck</strong>, 
      including their data sources, latest available year, and freshness status.
    </p>
    <p>
      It helps you trace where each figure originates from and how recently it was updated â€” 
      a transparent foundation for all comparisons and analyses.
    </p>
    <p class="note">
      Data years are color-coded for freshness, and ðŸ”º marks statistical outliers 
      detected through automated analysis.
    </p>
  </section>

  <!-- ðŸ“‘ Tabelle -->
  <section id="glossary-container">
    <table id="glossary-table">
      <thead>
        <tr>
          <th>KPI</th>
          <th>Source</th>
          <th>Data Year</th>
          <th>Last Fetch</th>
          <th>Outliers</th>
        </tr>
      </thead>
      <tbody id="glossary-body">
        <tr><td colspan="5" style="text-align:center;">Loading data â€¦</td></tr>
      </tbody>
    </table>

    <div id="legend">
      <span class="fresh">ðŸŸ© Fresh (â‰¤ 1 yr)</span> Â· 
      <span class="warn">ðŸŸ¨ Moderate (â‰¤ 3 yrs)</span> Â· 
      <span class="stale">ðŸŸ¥ Stale / n a (> 3 yrs)</span> Â· 
      <span class="outlier">ðŸ”º Data Outliers</span>
    </div>
  </section>

  <!-- âš™ï¸ Skript -->
  <script>
  async function loadGlossary() {
    try {
      const [fetchRes, outlierRes] = await Promise.all([
        fetch("data/fetch_status.json"),
        fetch("data/analysis_outliers.json")
      ]);
      const data = await fetchRes.json();
      const outliers = await outlierRes.json();

      const tbody = document.getElementById("glossary-body");
      tbody.innerHTML = "";

      const kpis = data.kpis || {};
      const nowYear = new Date().getFullYear();

      for (const [id, info] of Object.entries(kpis)) {
        const tr = document.createElement("tr");
        const out = outliers[id] || {};
        const flagged = out.flagged || [];

        // ðŸ§® Bestimme Data Year â€“ wenn leer, dynamisch aus /data/{id}.json
        let dy = parseInt(info.data_year);
        if (!dy || dy < 1900) {
          try {
            const kpiFile = await fetch(`data/${id}.json`);
            if (kpiFile.ok) {
              const kpiData = await kpiFile.json();
              const years = Array.isArray(kpiData)
                ? kpiData.map(e => e.year).filter(y => y)
                : Object.values(kpiData).map(e => e.year).filter(y => y);
              if (years.length) dy = Math.max(...years);
            }
          } catch {}
        }

        const diffY = dy ? nowYear - dy : 99;
        const clsYear = diffY <= 1 ? "fresh" : diffY <= 3 ? "warn" : "stale";

        let clsOut = "";
        if (flagged.length >= 10) clsOut = "outlier";
        else if (flagged.length > 0) clsOut = "warn";

        const minInfo = out.min ? `${out.min.country || "?"} (${out.min.year || "?"})` : "â€“";
        const maxInfo = out.max ? `${out.max.country || "?"} (${out.max.year || "?"})` : "â€“";

        // ðŸ“… Format Last Fetch (Monat Jahr)
        let formattedFetch = "â€“";
        if (info.last_fetch) {
          const d = new Date(info.last_fetch);
          if (!isNaN(d)) {
            formattedFetch = d.toLocaleString("en-US", { month: "short", year: "numeric" });
          }
        }

        tr.innerHTML = `
          <td>${id}</td>
          <td>${info.source ? `<a href="${info.source}" target="_blank">${info.source}</a>` : "?"}</td>
          <td class="${clsYear}">${dy || "n/a"}</td>
          <td>${formattedFetch}</td>
          <td class="${clsOut}">
            ${flagged.length ? `ðŸ”º ${flagged.length}` : "â€“"}
            <span class="outlier-info">
              min: ${minInfo}, max: ${maxInfo}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      }
    } catch (err) {
      console.error("Glossary load failed:", err);
      document.getElementById("glossary-body").innerHTML =
        `<tr><td colspan="5" style="text-align:center;color:red;">Error loading data</td></tr>`;
    }
  }

  window.addEventListener("DOMContentLoaded", loadGlossary);
  </script>
</body>
</html>
