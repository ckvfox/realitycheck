<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RealityCheck â€“ Data Glossary</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <section id="glossary-container">
    <h2>ðŸ“Š Data Glossary</h2>
    <p id="data-meta">
      Overview of all KPIs currently included in <strong>RealityCheck</strong>, with their source,
      latest available data year, and last update.<br>
      Both <em>data year</em> and <em>source date</em> are color-coded for freshness.
      Outlier information (ðŸ”º) is integrated based on statistical analysis.
    </p>

    <table id="glossary-table">
      <thead>
        <tr>
          <th>KPI</th>
          <th>Source</th>
          <th>Data Year</th>
          <th>Source Date</th>
          <th>Last Fetch</th>
          <th>Outliers</th>
        </tr>
      </thead>
      <tbody id="glossary-body">
        <tr><td colspan="6" style="text-align:center;">Loading data â€¦</td></tr>
      </tbody>
    </table>

    <div id="legend">
      <span class="fresh">ðŸŸ© Fresh (â‰¤ 1 yr)</span> Â· 
      <span class="warn">ðŸŸ¨ Moderate (â‰¤ 3 yrs)</span> Â· 
      <span class="stale">ðŸŸ¥ Stale / n/a (> 3 yrs)</span> Â· 
      <span class="outlier">ðŸ”º Data Outliers</span>
    </div>
  </section>

  <script>
  async function loadGlossary() {
    try {
      const [fetchRes, outlierRes] = await Promise.all([
        fetch("data/fetch_status.json"),
        fetch("data/analysis_outliers.json")
      ]);
      const data = await fetchRes.json();
      const outliers = await outlierRes.json();

      const tbody = document.getElementById("glossary-body");
      tbody.innerHTML = "";

      const kpis = data.kpis || {};
      const nowYear = new Date().getFullYear();

      Object.entries(kpis).forEach(([id, info]) => {
        const tr = document.createElement("tr");
        const out = outliers[id] || {};
        const flagged = out.flagged || [];

        const dy = parseInt(info.data_year) || 0;
        const diffY = dy ? nowYear - dy : 99;
        const clsYear = diffY <= 1 ? "fresh" : diffY <= 3 ? "warn" : "stale";

        const sd = info.source_date;
        let clsSrc = "stale";
        if (sd && /\d{4}/.test(sd)) {
          const y = parseInt(sd.match(/\d{4}/)[0]);
          const diffS = nowYear - y;
          clsSrc = diffS <= 1 ? "fresh" : diffS <= 3 ? "warn" : "stale";
        }

        let clsOut = "";
        if (flagged.length >= 10) clsOut = "outlier";
        else if (flagged.length > 0) clsOut = "warn";

        const minInfo = out.min ? `${out.min.country || "?"} (${out.min.year || "?"})` : "â€“";
        const maxInfo = out.max ? `${out.max.country || "?"} (${out.max.year || "?"})` : "â€“";

        tr.innerHTML = `
          <td>${id}</td>
          <td>${info.source ? `<a href="${info.source}" target="_blank">${info.source}</a>` : "?"}</td>
          <td class="${clsYear}">${info.data_year || "n/a"}</td>
          <td class="${clsSrc}">${info.source_date || "n/a"}</td>
          <td>${info.last_fetch || "â€“"}</td>
          <td class="${clsOut}">
            ${flagged.length ? `ðŸ”º ${flagged.length}` : "â€“"}
            <span class="outlier-info">
              min: ${minInfo}, max: ${maxInfo}
            </span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error("Glossary load failed:", err);
      document.getElementById("glossary-body").innerHTML =
        `<tr><td colspan="6" style="text-align:center;color:red;">Error loading data</td></tr>`;
    }
  }

  window.addEventListener("DOMContentLoaded", loadGlossary);
  </script>

</body>
</html>