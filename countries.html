<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RealityCheck â€“ Countries</title>

  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>

	<section class="page-intro">
	  <h1>ğŸ—ºï¸ RealityCheck â€“ Countries Dashboard</h1>
	  <p>
		The world is in turmoil. Radicalization, polarization, and populism often dominate the headlines â€” 
		and many say that everything used to be better and that today everything is going downhill. 
		But is that really true?
	  </p>
	  <p>
		<strong>No!</strong> At least not in many areas. The facts paint a different picture. 
		Prejudices and gut feelings can be refuted with data from reliable sources. 
		When you compare key figures, put them into context (per capita, per kmÂ², per GDP) 
		and also look at historical developments, you realize that many things are constantly improving â€” worldwide.
	  </p>
	  <p>
		This project is inspired by <strong><em>Hans Rosling</em></strong>â€™s book 
		<a href="https://en.wikipedia.org/wiki/Factfulness" target="_blank" rel="noopener"><em>Factfulness</em></a> 
		and invites you to discover and classify the data yourself. 
		In the spirit of <strong><em>W. Edwards Deming</em></strong> â€“ â€œIn God we trust. All others must bring dataâ€ â€“ 
		we aim to foster a more nuanced understanding of global trends.
	  </p>
	  <p class="note">
		Each chart and map below visualizes a key national indicator from the RealityCheck dataset â€” 
		offering perspective on where each country stands and how it evolves over time.
	  </p>
	</section>



	<!-- Controls (zentriert) -->
	<section id="controls">

	  <div class="control-pair">
		<label for="kpiSelect">KPI:</label>
		<select id="kpiSelect"></select>
	  </div>

	  <!-- ğŸ”„ Fullscreen Loading Spinner (zentriert, beeinflusst Layout nicht) -->
	  <div id="overlay-spinner">
		<div></div>
		<p>Loading country KPI data...</p>
	  </div>

	  <div class="control-pair">
		<label for="yearSelect">Comparison Year:</label>
		<select id="yearSelect"></select>
	  </div>

	  <div class="control-pair">
		<label for="relationSelect">Relation:</label>
		<select id="relationSelect">
		  <option value="absolute">Absolute</option>
		  <option value="percapita">Per Capita</option>
		  <option value="pergdp">Per GDP</option>
		  <option value="perkm2">Per kmÂ²</option>
		</select>
	  </div>

	  <div class="control-pair">
		<label for="countrySelect">Home Country:</label>
		<select id="countrySelect"></select>
	  </div>
	</section>

	<!-- Warnbox & KPI-Beschreibung -->
	<div id="warning-box" class="hidden" style="max-width:var(--max-width);margin:0 auto;">
	âš ï¸ <strong>Attention:</strong> No current data is available for some countries. Older values were used.
	</div>
	<div id="kpi-description" style="max-width:var(--max-width);margin:.5rem auto 1rem;font-style:italic;"></div>

  <!-- Tabelle -->
  <section id="data-table">
    <table id="country-table" aria-label="Country data table">
      <thead>
        <tr>
          <th data-col="rank">Rank</th>
          <th data-col="country">Country</th>
          <th data-col="value">Value</th>
          <th title="Change vs previous year">Î” vs Prev</th>
          <th title="Change vs comparison year">Î” vs Year</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Quelle & Datum -->
  <div id="data-meta">
    Source: <a id="data-source" href="#" target="_blank" rel="noopener">---</a><br>
    Last update: <span id="data-date">---</span>
  </div>

<!-- Chart -->
	<section id="chart-container">
	  <canvas id="kpi-chart"></canvas>

	  <div class="chart-selects">
		<label>Compare:</label>
		<select id="country1Select"></select>
		<select id="country2Select"></select>
		<select id="country3Select"></select>
	  </div>
	</section>

  <!-- Map -->
  <section id="map-section">
    <div id="map"></div>
  </section>

  <!-- Legende -->
  <section id="legend">
    <h3>Legend:</h3>
    <ul>
      <li>â†‘ Increase, â†“ Decrease, â†’ No change (Î” vs previous year; hover for details)</li>
      <li>Î” vs Comparison Year in %</li>
      <li id="rounding-info">Values shown consistently per KPI</li>
      <li>Data correctness lies with the original source</li>
      <li>Groups have no ranking, Î” vs PrevYear, and no comparison year values</li>
      <li>Countries without available data for the selected KPI are not shown in the table</li>
      <li>KPIs in <em>grey italic</em> have no data available yet</li>
      <li>Groups (e.g. NATO, EU) are shown after countries, calculated as the sum of their members</li>
    </ul>
  </section>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
<script src="scripts/core.js"></script>
<script src="scripts/script.js"></script>

<script>
  // --- DEBUG --------------------------------------------
  console.log("âœ… countries.html loaded");


  window.addEventListener("load", () => {
    if (typeof updateChart === "function") {
      console.log("â¡ï¸ updateChart()");
      updateChart();
    }

    // --- Leaflet Map Retry Logic ---
    function startMap(attempt = 1) {
      const maxAttempts = 10;
      const mapEl = document.getElementById("map");
      const ready = mapEl && mapEl.offsetHeight > 0 && mapEl.offsetWidth > 0;

      console.log(`ğŸ—ºï¸ Map init attempt ${attempt} (visible=${ready})`);

      if (!ready && attempt < maxAttempts) {
        return setTimeout(() => startMap(attempt + 1), 500);
      }

      if (typeof initMap === "function") {
        try {
          console.log("â¡ï¸ initMap()");
          initMap();
          setTimeout(() => {
            if (window.map && window.map.invalidateSize) {
              console.log("â¡ï¸ invalidateSize()");
              window.map.invalidateSize();
            }
          }, 800);
        } catch (e) {
          console.error("âŒ initMap() failed", e);
        }
      } else {
        console.warn("âš ï¸ initMap() not defined");
      }
    }

    startMap();
  });
</script>

</body>
</html>